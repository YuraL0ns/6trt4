# Исправления перезапуска задач и обработки фотографий

## Проблема 1: Отмененные задачи не перезапускаются

### Описание
Когда задача отменена в админ-панели, она получает статус `REVOKED` или `REJECTED`, но скрипт `restart_task.py` не мог её перезапустить, так как не обрабатывал эти статусы.

### Исправление
- Добавлена обработка статусов `REVOKED` и `REJECTED`
- Добавлена обработка статуса `RETRY`
- Улучшена логика получения аргументов задачи:
  - Попытка получить из метаданных
  - Попытка получить из результата
  - Попытка использовать task_id как event_id (если это UUID)
  - Попытка получить из БД Laravel

### Использование
```bash
# Перезапустить отмененную задачу
python restart_task.py <task_id>

# Принудительный перезапуск (даже для PENDING задач)
python restart_task.py <task_id> --force
```

## Проблема 2: Задача зависает на части фотографий

### Описание
При обработке большого количества фотографий (например, 1768) задача могла зависнуть на меньшем количестве (например, 994), так как:
1. В `event_info.json` могло быть меньше фотографий, чем в БД
2. Прогресс обновлялся только после успешной обработки каждой фотографии
3. Если обработка одной фотографии зависала, прогресс не обновлялся

### Исправление
1. **Исправлена логика загрузки фотографий:**
   - Если в `event_info.json` меньше фотографий, чем в БД, используются все фотографии из БД
   - Это гарантирует обработку всех фотографий, а не только тех, что в `event_info.json`

2. **Улучшено обновление прогресса:**
   - Прогресс обновляется в начале обработки каждой фотографии
   - Это позволяет видеть, что задача не зависла, даже если обработка одной фотографии занимает много времени
   - Прогресс обновляется даже при ошибках обработки

3. **Добавлено начальное обновление прогресса:**
   - Прогресс устанавливается в 0% в начале обработки
   - Это помогает отслеживать начало задачи

### Результат
- Все фотографии из БД обрабатываются, даже если их больше, чем в `event_info.json`
- Прогресс обновляется чаще, что позволяет видеть, что задача работает
- Задача не зависает из-за проблем с одной фотографией

## Проверка работы

### Проверить статус задачи
```bash
docker exec hunter-photo-fastapi python -c "from celery.result import AsyncResult; from tasks.celery_app import celery_app; r = AsyncResult('<task_id>', app=celery_app); print(f'State: {r.state}, Info: {r.info}')"
```

### Перезапустить отмененную задачу
```bash
docker exec -it hunter-photo-fastapi bash
python restart_task.py <task_id> --force
```

### Проверить логи обработки
```bash
docker exec hunter-photo-fastapi tail -f /app/logs/tasks/process_event_photos_<task_id>.log
```

