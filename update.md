# –°–†–û–ß–ù–û –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
1. –§–û—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—å –ø–æ –æ—Ä–µ–∏–Ω—Ç–∞—Ü–∏–∏ –∫–∞–∫ –±—ã–ª–æ —É EXIF, –≤—Å–µ —Ç–∞–∫ –∂–µ –±–æ–∫–æ–º —Å—Ç–æ—è—Ç –∞ –Ω–µ –∫–∞–∫ –Ω–∞–¥–æ
2. –õ–∏—Ü–∞ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç, –ø–æ–ª—è face_search –∏ face_boxes –ø—É—Å—Ç—ã–µ, —Ö–æ—Ç—è –ø–∏—à–µ—Ç —è–∫–æ–±—ã –∞–Ω–∞–ª–∏–∑ –ø–æ –Ω–∏–º –±—ã–ª.
3. –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª –Ω–∞ –æ–±–ª–∞–∫–æ s3 –Ω–µ—Ç —Å—Å—ã–ª–∫–∏ 
4. –ù–µ–∫—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏–º–µ–Ω–∏


# CRITICAL ERROR
```json
{
    "id": "a0b544fe-4680-43b8-a9e1-5bb2e8f3445d",
    "event_id": "a0b544ee-01ff-4591-b71d-cb1d30d8b7be",
    "price": "60.00",
    "has_faces": false,
    "original_path": "events\/a0b544ee-01ff-4591-b71d-cb1d30d8b7be\/original_photo\/8ec7c2c6-e9ae-4757-8413-e33f2efd2e89.JPG",
    "custom_path": "events\/a0b544ee-01ff-4591-b71d-cb1d30d8b7be\/custom_photo\/4a9ca477-42af-4c6f-a136-113f05924db6.webp",
    "face_vec": null,
    "face_encodings": null,
    "numbers": null,
    "exif_data": null,
    "created_at_exif": null,
    "date_exif": null,
    "status": "pending",
    "original_name": "1de38bc5-4884-4439-b95d-6690d4ec982d.JPG",
    "custom_name": null,
    "s3_custom_url": "https:\/\/s3.twcstorage.ru\/a63b55a4-hunterphoto\/hunter-photo\/events\/a0b544ee-01ff-4591-b71d-cb1d30d8b7be\/custom_photo\/4a9ca477-42af-4c6f-a136-113f05924db6.webp",
    "s3_original_url": null,
    "created_at": "2025-12-29T10:27:50.000000Z",
    "updated_at": "2025-12-29T10:30:26.000000Z",
    "face_bboxes": null,
    "event": {
        "id": "a0b544ee-01ff-4591-b71d-cb1d30d8b7be",
        "author_id": "a07fb801-54d3-49a1-b32f-a0f40cc452d8",
        "title": "5555",
        "slug": "5555",
        "city": "5555",
        "date": "2025-12-09T00:00:00.000000Z",
        "cover_path": "events\/a0b544ee-01ff-4591-b71d-cb1d30d8b7be\/covers\/6952579bb5b59_1767004059.JPG",
        "price": "60.00",
        "status": "published",
        "description": "5555",
        "created_at": "2025-12-29T10:27:39.000000Z",
        "updated_at": "2025-12-29T10:30:26.000000Z"
    },
    "carts": [],
    "order_items": [],
    "face_searches": []
}
```

–ö–∞–∫ –≤–∏–¥–∏—à—å –Ω–µ —á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å —å–≤–æ–æ–±—â–µ, –∫–∞–∫ –Ω–µ—ã–±–ª–æ –∏–º–µ–Ω, –∏–ª–∏ –∂–µ –Ω–µ –ø–≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ø–æ–∏—Å–∫ —Ç–∞–∫ –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ —á–µ–≥–æ –∏ –Ω–µ—Ç

2. –õ–∏—Ü–∞ –Ω–µ –∏—Å—á–µ—Ç –≤ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –∏—â–µ—Ç –ª–∏—Ü–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏ –Ω–µ –≤—ã–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ 
3. –û–±–ª–æ–∂–∫–∞ —Å–æ–±—ã—Ç–∏—è —Ç–æ–∂–µ –ø—É—Å—Ç–∞—è —Å—Ç–∞–ª–∞, —Ä–∞–Ω–µ–µ —Ç—É—Ç –±—ã–ª–∏ –Ω–∞–¥–ø–∏—Å–∏ (–Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç–∞ –≥–æ—Ä–æ–¥, —Å–µ–π—á–∞—Å –∂–µ –Ω–µ —á–µ–≥–æ –Ω–µ—Ç—É)
4. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –ø–æ–≤–∞—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –Ω–µ –∫—Ä—É—Ç—è—Ç—Å—è, –∫–∞–∫ –±—ã–ª–∏ –±–æ–∫–æ–º —Ç–∞–∫ –∏ –æ—Å—Ç–∞–ª–∏—Å—å, remove_exif_and_rotate –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–∞–¥–æ, –∞ —Ç–æ—á–Ω–µ–µ —Å–∫–∞–∑–∞—Ç—å –≤–æ–æ–±—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
5. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫—É–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å watermark —Ç–µ–ø–µ—Ä—å –±–µ–∑ –Ω–µ–≥–æ, –∏ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–µ –æ–±—Ä–µ–∑–æ–Ω–æ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–∞–∫ —É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –¥–∞ –∏ –∫ —Ç–æ–º—É –∂–µ –∫–æ–Ω–≤–µ—Ä—Ç—Ü–∞–∏–∏ –≤ webp –Ω–µ—Ç—É 

# CRIT Block
```
–í –ß–Å–ú –†–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê
1Ô∏è‚É£ Celery –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏, —á–µ–º —Ç–≤–æ–π —Ç–µ—Å—Ç

–û—á–µ–Ω—å —á–∞—Å—Ç–æ:

–¥—Ä—É–≥–æ–π PYTHONPATH

–¥—Ä—É–≥–æ–π cwd

–¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

–¥—Ä—É–≥–∞—è —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è

–¥—Ä—É–≥–æ–π CPU context

üëâ –í –∏—Ç–æ–≥–µ:

settings.INSIGHTFACE_MODEL_PATH —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ —Ç—É–¥–∞

–º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

self.model.get(img) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç []

–æ—à–∏–±–æ–∫ –Ω–µ—Ç (InsightFace —Ç–∞–∫ –¥–µ–ª–∞–µ—Ç)

2Ô∏è‚É£ InsightFace –ù–ï –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–£ —Ç–µ–±—è —Å–µ–π—á–∞—Å:

face_recognition = FaceRecognition()


–≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π Celery-–∑–∞–¥–∞—á–∏

‚ùå –≠—Ç–æ –ø–ª–æ—Ö–æ –¥–ª—è:

fork-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤

multiprocessing

Celery prefork

InsightFace –¥–æ–ª–∂–µ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å,
–∞ –Ω–µ –Ω–∞ –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É.

3Ô∏è‚É£ Celery –º–æ–∂–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –î–û —Ç–æ–≥–æ, –∫–∞–∫ –º–æ–¥–µ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã

–û—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏:

–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

volume

–∞–≤—Ç–æ—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

InsightFace:

–Ω–µ –ø–∞–¥–∞–µ—Ç

–ø—Ä–æ—Å—Ç–æ ¬´–Ω–µ –≤–∏–¥–∏—Ç –ª–∏—Ü–∞¬ª

üî• –ì–õ–ê–í–ù–´–ô –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û (—É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å)

—Ç—ã –∑–∞–ø—É—Å—Ç–∏–ª –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
–∏ –≤—Å—ë –∏–¥–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

üëâ –∑–Ω–∞—á–∏—Ç:

–∫–æ–¥ FaceRecognition —Ä–∞–±–æ—á–∏–π

–º–æ–¥–µ–ª–∏ –≤–∞–ª–∏–¥–Ω—ã

–ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ EXIF

–ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ InsightFace –∫–∞–∫ —Ç–∞–∫–æ–≤–æ–º

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï (–Ω–µ –∫–æ—Å—Ç—ã–ª—å)
üß† –ü—Ä–∞–≤–∏–ª–æ ‚Ññ1

InsightFace –Ω–µ–ª—å–∑—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ Celery-task

‚úÖ –ö–ê–ö –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨
üî• –í utils/face_recognition.py

–í –°–ê–ú–û–ú –ù–ò–ó–£ —Ñ–∞–π–ª–∞:

_face_recognition_singleton = None

def get_face_recognition() -> FaceRecognition:
    global _face_recognition_singleton
    if _face_recognition_singleton is None:
        _face_recognition_singleton = FaceRecognition()
    return _face_recognition_singleton

üî• –í face_search.py (–∏ –≤–µ–∑–¥–µ)

‚ùå –ë–´–õ–û:

face_recognition = FaceRecognition()


‚úÖ –°–¢–ê–õ–û:

from utils.face_recognition import get_face_recognition

face_recognition = get_face_recognition()


üìå –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ.

üî• –®–ê–ì 2. –û–¢–ö–õ–Æ–ß–ò PREFORK (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û)

Celery + ML = solo –∏–ª–∏ threads, –Ω–µ prefork.

–í celery_app.py:
worker_pool = 'solo'


–∏–ª–∏ –∑–∞–ø—É—Å–∫:

celery -A tasks.celery_app worker -l info -P solo


‚ùå prefork –ª–æ–º–∞–µ—Ç:

InsightFace

OpenCV

ONNX Runtime

üî• –®–ê–ì 3. –õ–û–ì –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê

–î–æ–±–∞–≤—å –û–î–ò–ù –õ–û–ì –≤ FaceRecognition.__init__:

logger.error(f"INSIGHTFACE INIT PID={os.getpid()} CWD={os.getcwd()} MODEL_PATH={model_path}")


–ò –æ–¥–∏–Ω –ø–µ—Ä–µ–¥ .get(img):

logger.error(f"GET FACES PID={os.getpid()} IMG_SHAPE={img.shape}")


–¢—ã —É–≤–∏–¥–∏—à—å, —á—Ç–æ:

–≤ Celery PID –¥—Ä—É–≥–æ–π

cwd –¥—Ä—É–≥–æ–π

–º–æ–¥–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–µ —Ç–∞–º

üî• –ü–û–ß–ï–ú–£ –°–ê–ô–¢ ¬´–ù–ò–ß–ï–ì–û –ù–ï –ù–ê–•–û–î–ò–¢¬ª

–ü–æ—Ç–æ–º—É —á—Ç–æ:

–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ ‚Üí –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

InsightFace –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞ ‚Üí –ø—É—Å—Ç–æ–π

extract_faces_with_bboxes ‚Üí []

has_faces=False

–¥–∞–ª—å—à–µ –ø–æ–∏—Å–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω

üß† –†–ï–ó–Æ–ú–ï (–∫–æ—Ä–æ—Ç–∫–æ)

‚úî –∫–æ–¥ FaceRecognition —Ä–∞–±–æ—á–∏–π
‚úî InsightFace —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ùå Celery –ª–æ–º–∞–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
‚ùå –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–µ —Ç–∞–º –∏ –Ω–µ —Ç–∞–∫
‚ùå prefork —É–±–∏–≤–∞–µ—Ç ML

üöÄ –ß–¢–û –î–ï–õ–ê–ï–ú –°–ï–ô–ß–ê–°

1Ô∏è‚É£ –í—ã–Ω–µ—Å—Ç–∏ InsightFace –≤ singleton
2Ô∏è‚É£ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ Celery –≤ -P solo
3Ô∏è‚É£ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥ PID/CWD
4Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä
5Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∏—Ç—å –û–î–ù–û —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å has_faces=True
```

